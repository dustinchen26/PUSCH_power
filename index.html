<!-- 
  Copyright © [2023] [Dustin_Chen]. All rights reserved.
  Author: Dustin Chen
  Email:  Dustin_Chen@compal.com or chuhpsdustin@gmail.com
-->  

<!DOCTYPE html>
<html>
<head>
    <title>PUSCH Transmit Power Calculator</title>
	
<style>
    /* 調整輸入框的寬度 */
    input[type="number"] {
        width: 50px;
    }
</style>	
	
</head>
<body>
    <h1>PUSCH Transmit Power Calculator</h1>
	<p style="margin: 0;">Author: Dustin_Chen, email: <a href="mailto:Dustin_Chen@compal.com" style="line-height: 1;">Dustin_Chen@compal.com</a> or <a href="mailto:chuhpsdustin@gmail.com" style="line-height: 1;">chuhpsdustin@gmail.com</a></p>	
	<p>Ref: ETSI TS 138 213 chap 7  Uplink Power control sec 7.1  Physical uplink shared channel </p>
    <pre>
      <img src="https://raw.githubusercontent.com/dustinchen26/PUSCH_power/master/formula.png" alt="GitHub Image" width="750">    </pre>
    <form id="pusch-form">
		
	<p><b>Enter the following parameters and press "Calculate" to get the PUSCH power</b><br></p>

    <ul>
        <li>	
			<label for="p0-NominalWithGrant">p0-NominalWithGrant:</label>
			<input type="number" step="any" id="p0-NominalWithGrant" required value="-70"><br>
        </li>
		
        <li>	
			<label for="p0">p0:</label>
			<input type="number" step="any" id="p0" required value="-10"><br>
        </li>
		
        <li>	
			<label for="mu">μ:</label>
			<input type="number" step="any" id="mu" required value="1"><br>
        </li>

        <li>	
			<label for="num-RB">Num RB:</label>
			<input type="number" id="num-RB" required value="16"><br>
        </li>

        <li>	
			<label for="alpha">α:</label>
			<input type="number" step="any" id="alpha" required value="1"><br>
        </li>

        <li>	
			<label for="pathloss">Pathloss:</label>
			<input type="number" step="any" id="pathloss" required value="32"><br>
        </li>

        <li>	
			<label for="delta-TF">Delta TF:</label>
			<input type="number" step="any" id="delta-TF" required value="2"><br>
        </li>

        <li>	
			<label for="tpc-adjustment">TPC Adjustment:</label>
			<input type="number" step="any" id="tpc-adjustment" required value="0"><br>
        </li>
    </ul>
        <button type="button" onclick="calculatePower()">Calculate</button>
    </form>
	 
    <pre id="calculation-result">

    </pre>

    <script>
        function calculatePower() {
            const p0_NominalWithGrant = parseFloat(document.getElementById('p0-NominalWithGrant').value);
            const mu = parseFloat(document.getElementById('mu').value);
            const num_RB = parseInt(document.getElementById('num-RB').value);
            const p0 = parseFloat(document.getElementById('p0').value);
            const alpha = parseFloat(document.getElementById('alpha').value);
            const pathloss = parseFloat(document.getElementById('pathloss').value);
            const delta_TF = parseFloat(document.getElementById('delta-TF').value);
            const tpc_adjustment = parseFloat(document.getElementById('tpc-adjustment').value);

            const pusch_transmit_power = p0_NominalWithGrant + 10 * (Math.log10(2 ** mu * num_RB)) + p0 + alpha * pathloss + delta_TF + tpc_adjustment;

            const calculationDetails = `PUSCH Transmit Power
=  P_PUSCH
=  min{ P_CMAX , P_O_PUSCH                          + 10*log(2^μ * M_PUSCH_RB)+ α * PL + ΔTF + f }
=  min{ MTPL   , P_O_NOMINAL_PUSCH   + P_O_UE_PUSCH + 10*log(2^μ * M_PUSCH_RB)+ α * PL + ΔTF + f }
=  min{ MTPL   , p0-NominalWithGrant + p0           + 10*log(2^μ * NumRB) + alpha * Pathloss + Delta_TF + TPC_Adjustment }
=  p0-NominalWithGrant + p0   + 10 * log(2^μ* NumRB ) + alpha * Pathloss + Delta_TF + TPC_Adjustment
=   ${p0_NominalWithGrant}               + (${p0}) + 10 * log10(2^${mu} * ${num_RB})  +  ${alpha}   *   ${pathloss}      +   ${delta_TF}     +   ${tpc_adjustment}
= ${pusch_transmit_power.toFixed(2)} dBm`;

            document.getElementById('calculation-result').innerText = calculationDetails;
        }
    </script>
	
<pre>
=========================================================================================================================
// DU xml
        &lt;nSsbPwr&gt;-15&lt;/nSsbPwr&gt;
        &lt;puschPwrCfg&gt;
            &lt;msg3deltaPreamble&gt;0&lt;/msg3deltaPreamble&gt;
            &lt;p0nominal&gt;-70&lt;/p0nominal&gt;
            &lt;msg3alpha&gt;ALL&lt;/msg3alpha&gt;
            &lt;p0&gt;-10&lt;/p0&gt;
            &lt;alpha&gt;ALL&lt;/alpha&gt;
            &lt;deltaMcsEnabled&gt;true&lt;/deltaMcsEnabled&gt;
            &lt;isAccumulated&gt;true&lt;/isAccumulated&gt;
        &lt;/puschPwrCfg&gt;

// UE log
07:59:43.496	[0xB821]	BCCH_DL_SCH / SystemInformationBlockType1
          uplinkConfigCommon 
          {
            frequencyInfoUL 
            {
              scs-SpecificCarrierList 
              {
                {
                  subcarrierSpacing kHz30, //μ=1
                }
              },
              p-Max 33
            },
            initialUplinkBWP 
            {
              genericParameters 
              {
                subcarrierSpacing kHz30 //μ=1
              },
              pusch-ConfigCommon setup : 
                {
                  p0-NominalWithGrant -70 //p0-NominalWithGrant = -70
                },
          ss-PBCH-BlockPower -15 // Pathloss = ss-PBCH-BlockPower - RSRP = (-15) - (-46.28) = 31.28 near 32
        },

// RSRP = -46.28
07:59:43.614	[0xB97F]	NR5G ML1 Searcher Measurement Database Update Ext
      -----------------------------------------------------------------------------------------------------------------------------------------
      |   |      |      |     |            |            |Detected Beams                                                                       |
      |   |      |      |     |            |            |   |     |RX Beam Info           |NR2NR       |NR2NR       |L2NR        |L2NR        |
      |   |      |PBCH  |Num  |Cell Quality|Cell Quality|   |SSB  |RX Beam|               |Filtered Tx |Filtered Tx |Filtered Tx |Filtered Tx |
      |#  |PCI   |SFN   |Beams|RSRP        |RSRQ        |#  |Index|Id     |RSRP           |Beam RSRP L3|Beam RSRQ L3|Beam RSRP L3|Beam RSRQ L3|
      -----------------------------------------------------------------------------------------------------------------------------------------
      |  0|     1|   804|    1|     -46.281|     -10.359|  0|    0|     NA|        -46.266|     -46.281|     -10.359|          NA|          NA|
      |   |      |      |     |            |            |   |     |     NA|        -48.594|            |            |            |            |

07:59:43.640    [0xB821]    DL_CCCH / RRC Setup
                              p0-AlphaSets 
                              {
                                {
                                  p0-PUSCH-AlphaSetId 0,
                                  p0 -10, //p0=-10
                                  alpha alpha1 //alpha=1
                                }

// (808,19) PUSCH Num RB=16
07:59:43.665    [0xB883]    NR5G MAC UL Physical Channel Schedule Report
   ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   |   |                     |       |Carriers                                                                      
   |   |                     |       |       |              |                                   |      |                                                                            
   |   |                     |       |       |              |                                   |      |PUSCH Data                                                                  
   |   |                     |       |       |              |                                   |      |            |      |       |    |    |                |    |       |       |
   |   |                     |       |       |              |                                   |Dual  |            |      |       |    |    |                |DMRS|       |       |
   |   |System Time          |Num    |Carrier|              |                                   |Pol   |Is Second   |Start |Num    |HARQ|    |                |Add |RB     |       |
   |#  |Slot|Numerology|Frame|Carrier|ID     |RNTI Type     |Phychan Bit Mask                   |Status|Phychan     |Symbol|Symbols|ID  |MCS |MCS Table       |Pos |Start  |Num RBs|
   ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
   |  0|  19|     30kHz|  808|      1|      0|        C_RNTI|                              PUSCH|     0|           0|     0|     12|   0|   9|           64QAM|   1|      0|     16|

// (808,19) PUSCH Pathloss=32, Delta TF=2, TPC Adjustment=0, PUSCH Transmit Power = -30
07:59:43.693    [0xB8D2]    NR5G LL1 FW MAC TX IU Power
         System Frame Number       = 808
         SCS                       = 1
         Slot Number               = 19
      Power Info
         --------------------------------------------------------------------------
         |   |       |       |CarrierIdType                                        
         |   |       |       |PUSCH Data                                          |
         |   |Carrier|Channel|Transmit|        |TPC       |PHR |Delta|Is  |Minimum|
         |#  |Id     |Type   |Power   |Pathloss|Adjustment|MTPL|TF   |Msg3|Power  |
         --------------------------------------------------------------------------
         |  0|      0|  PUSCH|     -30|      32|         0|  21|    2|   0|    -38|
</pre>	
	
</body>
</html>
